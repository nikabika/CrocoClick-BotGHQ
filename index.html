<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ü–æ–¥–¥–µ—Ä–∂–∫–∞</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
        }

        body {
            background-color: #000;
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Helvetica Neue', sans-serif;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }

        .header {
            position: sticky;
            top: 0;
            height: 50px;
            background: #2C2C2E;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            border: none;
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 18px;
            font-weight: 600;
        }

        .back-button {
            position: absolute;
            left: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #fff;
            font-size: 24px;
        }

        .content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            padding-top: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .card {
            background-color: #2C2C2E;
            border-radius: 12px;
            padding: 10px 12px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            width: 95%;
            min-height: 60px;
            cursor: pointer;
        }

        .emoji {
            font-size: 28px;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .text-content {
            flex: 1;
            overflow: hidden;
        }

        .title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .subtitle {
            font-size: 13px;
            opacity: 0.7;
            font-weight: 400;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .add-button {
            position: fixed;
            bottom: 25px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 13px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            z-index: 1000;
            border: none;
            cursor: pointer;
        }

        .add-button i {
            font-size: 24px;
            color: white;
        }

        /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è */
        html, body {
            touch-action: manipulation;
            overscroll-behavior: none;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —ç–∫—Ä–∞–Ω–∞ —á–∞—Ç–∞ */
        .chat-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #000;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }

        .chat-screen.active {
            opacity: 1;
            pointer-events: all;
        }

        .chat-header {
            height: 50px;
            background: #2C2C2E;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            padding: 0 16px;
        }

        .chat-title {
            font-size: 18px;
            font-weight: 600;
        }

        .chat-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .message {
            background-color: #2C2C2E;
            border-radius: 15px;
            padding: 12px;
            margin-bottom: 16px;
            max-width: 85%;
            align-self: flex-start;
        }

        .message.user {
            background-color: var(--accent-color);
            align-self: flex-end;
        }

        .admin-button {
            background-color: #2C2C2E;
            border-radius: 15px;
            padding: 12px 16px;
            margin-top: 16px;
            text-align: center;
            font-weight: 500;
            display: none;
            width: 100%;
            cursor: pointer;
        }

        .highlight {
            color: var(--accent-color);
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–ª–∞—à–∫–∏ –≤—Ö–æ–¥–∞ */
        .join-notification {
            background-color: #2C2C2E;
            border-radius: 17px;
            padding: 8px 16px;
            margin: 10px auto;
            text-align: center;
            font-size: 13px;
            max-width: 80%;
            display: none;
        }

        .join-notification .highlight {
            color: var(--accent-color);
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–¥–≤–∞–ª–∞ —á–∞—Ç–∞ */
        .chat-footer {
            background-color: #2C2C2E;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            display: none;
        }

        .message-input {
            flex: 1;
            background-color: #000;
            border: none;
            border-radius: 20px;
            padding: 12px 16px;
            color: #fff;
            font-size: 16px;
            outline: none;
        }

        .message-input::placeholder {
            color: #888;
        }

        .send-button {
            width: 0;
            height: 40px;
            background-color: var(--accent-color);
            border: none;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .send-button.active {
            width: 40px;
            opacity: 1;
        }

        .send-button i {
            color: white;
            font-size: 20px;
        }

        .messages-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="back-button" style="display: none;"><i data-feather="chevron-left"></i></div>
        <h1>Chats</h1>
    </header>

    <main class="content" id="chats-container">
        <div class="card" id="support-chat">
            <div class="emoji">ü§ñ</div>
            <div class="text-content">
                <div class="title">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</div>
                <div class="subtitle" id="last-message">–ü—Ä–∏–≤–µ—Ç! –Ø - –±–æ—Ç –ø–æ–¥‚Ä¶</div>
            </div>
        </div>
    </main>

    <button class="add-button" id="add-button">
        <i data-feather="plus"></i>
    </button>

    <!-- –≠–∫—Ä–∞–Ω —á–∞—Ç–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ -->
    <div class="chat-screen" id="support-screen">
        <div class="chat-header">
            <div class="back-button" id="back-from-support"><i data-feather="chevron-left"></i></div>
            <div class="chat-title">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</div>
        </div>
        <div class="chat-content">
            <div class="message">
                <p>ü§ñ –ü—Ä–∏–≤–µ—Ç!</p>
                <p>–Ø ‚Äî –±–æ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ <span class="highlight">DeepChat</span>. –û–±—Ä–∞—â–∞–π—Ç–µ—Å—å —Å –∂–∞–ª–æ–±–∞–º–∏, –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –æ—Ç–≤–µ—Ç–∏—Ç –≤–∞–º –≤ —Å–∫–æ—Ä–æ–º –≤—Ä–µ–º–µ–Ω–∏!</p>
            </div>
            <div class="admin-button" id="console-button">–ö–æ–Ω—Å–æ–ª—å</div>
        </div>
    </div>

    <!-- –≠–∫—Ä–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —á–∞—Ç–∞ -->
    <div class="chat-screen" id="user-chat-screen">
        <div class="chat-header">
            <div class="back-button" id="back-from-user-chat"><i data-feather="chevron-left"></i></div>
            <div class="chat-title" id="user-chat-title">–ß–∞—Ç</div>
        </div>
        <div class="chat-content">
            <div class="join-notification" id="join-notification">
                <span class="highlight">DeepAI</span> –≤—Å—Ç—É–ø–∏–ª(–∞) –≤ —á–∞—Ç
            </div>
            <div class="messages-container" id="messages-container"></div>
        </div>
        <div class="chat-footer" id="chat-footer">
            <input type="text" class="message-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ" id="message-input">
            <button class="send-button" id="send-button">
                <i data-feather="send"></i>
            </button>
        </div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
        let tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è feather icons
        feather.replace();
        
        // –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ü–µ–Ω—Ç–Ω—ã–π —Ü–≤–µ—Ç –∏–∑ Telegram WebApp
        const accentColor = tg.themeParams.button_color || '#40a7e3';
        document.documentElement.style.setProperty('--accent-color', accentColor);
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º –∞–∫—Ü–µ–Ω—Ç–Ω—ã–π —Ü–≤–µ—Ç –∫ —ç–ª–µ–º–µ–Ω—Ç–∞–º
        document.querySelectorAll('.add-button').forEach(btn => {
            btn.style.background = accentColor;
        });
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–æ–º
        const isAdmin = tg.initDataUnsafe.user?.username === 'temkazavr';
        if (isAdmin) {
            document.getElementById('console-button').style.display = 'block';
        }

        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        let userChats = [];
        let currentChatId = null;
        let messages = {};

        // –§—É–Ω–∫—Ü–∏—è –≤–∏–±—Ä–∞—Ü–∏–∏
        function vibrate(pattern) {
            if (navigator.vibrate) {
                navigator.vibrate(pattern);
            } else if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.HapticFeedback) {
                if (pattern === 3) {
                    window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
                } else if (Array.isArray(pattern)) {
                    window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
                    setTimeout(() => {
                        window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
                    }, 100);
                }
            }
        }

        // –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ —á–∞—Ç–∞
        function createNewChat() {
            if (!isAdmin && userChats.length >= 1) {
                tg.showPopup({
                    title: '–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ',
                    message: '–ú–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —á–∞—Ç',
                    buttons: [{type: 'ok'}]
                });
                return null;
            }

            const chatId = 'chat_' + Date.now();
            const chatName = '–ß–∞—Ç ' + (userChats.length + 1);
            
            userChats.push({
                id: chatId,
                name: chatName,
                lastMessage: '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π'
            });
            
            messages[chatId] = [];
            
            return chatId;
        }

        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —á–∞—Ç–æ–≤ –≤ —Å–ø–∏—Å–∫–µ
        function renderChats() {
            const container = document.getElementById('chats-container');
            
            // –û—á–∏—â–∞–µ–º –≤—Å–µ —á–∞—Ç—ã –∫—Ä–æ–º–µ –ø–æ–¥–¥–µ—Ä–∂–∫–∏
            const supportChat = document.getElementById('support-chat');
            container.innerHTML = '';
            container.appendChild(supportChat);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —á–∞—Ç—ã
            userChats.forEach(chat => {
                const chatElement = document.createElement('div');
                chatElement.className = 'card';
                chatElement.dataset.chatId = chat.id;
                chatElement.innerHTML = `
                    <div class="emoji">üí¨</div>
                    <div class="text-content">
                        <div class="title">${chat.name}</div>
                        <div class="subtitle">${chat.lastMessage}</div>
                    </div>
                `;
                
                chatElement.addEventListener('click', () => openUserChat(chat.id));
                container.appendChild(chatElement);
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —á–∞—Ç–∞
        function openUserChat(chatId) {
            vibrate(3);
            currentChatId = chatId;
            
            const chat = userChats.find(c => c.id === chatId);
            document.getElementById('user-chat-title').textContent = chat.name;
            document.getElementById('message-input').placeholder = `–°–æ–æ–±—â–µ–Ω–∏–µ –≤ ${chat.name}`;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —á–∞—Ç–æ–≤
            document.getElementById('join-notification').style.display = 'block';
            document.getElementById('chat-footer').style.display = 'flex';
            
            // –û—á–∏—â–∞–µ–º –∏ –∑–∞–ø–æ–ª–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
            const messagesContainer = document.getElementById('messages-container');
            messagesContainer.innerHTML = '';
            
            if (messages[chatId] && messages[chatId].length > 0) {
                messages[chatId].forEach(msg => {
                    addMessageToChat(msg.text, msg.isUser);
                });
            }
            
            document.getElementById('user-chat-screen').classList.add('active');
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç
        function addMessageToChat(text, isUser = true) {
            const messagesContainer = document.getElementById('messages-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : ''}`;
            messageDiv.textContent = text;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è —á–∞—Ç–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏
        function openSupportChat() {
            vibrate(3);
            document.getElementById('support-screen').classList.add('active');
        }

        // –ù–∞–≤–∏–≥–∞—Ü–∏—è –º–µ–∂–¥—É —ç–∫—Ä–∞–Ω–∞–º–∏
        document.getElementById('support-chat').addEventListener('click', openSupportChat);

        document.getElementById('back-from-support').addEventListener('click', function() {
            vibrate(3);
            document.getElementById('support-screen').classList.remove('active');
        });

        document.getElementById('back-from-user-chat').addEventListener('click', function() {
            vibrate(3);
            document.getElementById('user-chat-screen').classList.remove('active');
            renderChats(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
        document.getElementById('add-button').addEventListener('click', function() {
            vibrate([10, 100, 10]);
            
            const chatId = createNewChat();
            if (chatId) {
                renderChats();
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –Ω–æ–≤—ã–π —á–∞—Ç
                setTimeout(() => openUserChat(chatId), 100);
            }
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∫–æ–Ω—Å–æ–ª–∏
        document.getElementById('console-button').addEventListener('click', function() {
            tg.showPopup({
                title: '–ö–æ–Ω—Å–æ–ª—å –∞–¥–º–∏–Ω–∞',
                message: '–î–æ—Å—Ç—É–ø –∫ –∫–æ–Ω—Å–æ–ª–∏ —Ä–∞–∑—Ä–µ—à—ë–Ω',
                buttons: [{type: 'ok'}]
            });
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–æ–ª—è –≤–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        
        messageInput.addEventListener('input', function() {
            if (this.value.length > 0) {
                sendButton.classList.add('active');
            } else {
                sendButton.classList.remove('active');
            }
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏
        sendButton.addEventListener('click', function() {
            const text = messageInput.value.trim();
            if (text !== '' && currentChatId) {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                messages[currentChatId].push({
                    text: text,
                    isUser: true,
                    timestamp: Date.now()
                });
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Å–ø–∏—Å–∫–µ —á–∞—Ç–æ–≤
                const chatIndex = userChats.findIndex(c => c.id === currentChatId);
                if (chatIndex !== -1) {
                    userChats[chatIndex].lastMessage = text.length > 12 ? text.substring(0, 12) + '...' : text;
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
                addMessageToChat(text, true);
                
                // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
                messageInput.value = '';
                sendButton.classList.remove('active');
                
                // –û—Ç–≤–µ—Ç –±–æ—Ç–∞ (–∑–∞–≥–ª—É—à–∫–∞)
                setTimeout(() => {
                    const botResponse = "–ì–æ—Ç–æ–≤ –ø–æ–º–æ—á—å! –ß–µ–º –µ—â–µ –º–æ–≥—É –±—ã—Ç—å –ø–æ–ª–µ–∑–µ–Ω?";
                    messages[currentChatId].push({
                        text: botResponse,
                        isUser: false,
                        timestamp: Date.now()
                    });
                    addMessageToChat(botResponse, false);
                }, 1000);
            }
        });

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ Enter
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendButton.click();
            }
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–æ–ª–≥–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è
        let longPressTimer;
        const chatTitle = document.getElementById('user-chat-title');
        
        chatTitle.addEventListener('touchstart', function(e) {
            longPressTimer = setTimeout(function() {
                vibrate(3);
                const newName = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ (–¥–æ 8 —Å–∏–º–≤–æ–ª–æ–≤):', chatTitle.textContent);
                if (newName && newName.length <= 8) {
                    chatTitle.textContent = newName;
                    messageInput.placeholder = `–°–æ–æ–±—â–µ–Ω–∏–µ –≤ ${newName}`;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –≤ –º–∞—Å—Å–∏–≤–µ —á–∞—Ç–æ–≤
                    const chatIndex = userChats.findIndex(c => c.id === currentChatId);
                    if (chatIndex !== -1) {
                        userChats[chatIndex].name = newName;
                    }
                }
            }, 2000);
        });
        
        chatTitle.addEventListener('touchend', function() {
            clearTimeout(longPressTimer);
        });

        // –ó–∞–ø—Ä–µ—Ç –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –¥–µ–π—Å—Ç–≤–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        document.addEventListener('touchstart', function(e) {
            if (e.touches.length > 1) {
                e.preventDefault();
            }
        }, { passive: false });

        document.addEventListener('gesturestart', function(e) {
            e.preventDefault();
        });

        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
        });

        // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –≤—ã–¥–µ–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞
        document.addEventListener('selectstart', function(e) {
            e.preventDefault();
        });

        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∫–æ–Ω–∫–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ DOM
        const observer = new MutationObserver(() => {
            feather.replace();
        });
        observer.observe(document.body, { childList: true, subtree: true });
    </script>
</body>
</html>
